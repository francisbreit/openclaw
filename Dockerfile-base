# Use a imagem base do OpenClaw já construída
FROM alpine/openclaw:latest

# Instalar bash para melhor compatibilidade com scripts
RUN apk add --no-cache bash curl jq

# Criar diretório de trabalho e configurar usuário
WORKDIR /app

# Verificar se o OpenClaw está instalado na imagem base
RUN if [ -f /usr/local/bin/openclaw ]; then \
      echo "OpenClaw encontrado em /usr/local/bin/openclaw"; \
    elif [ -f /app/openclaw.mjs ]; then \
      echo "OpenClaw encontrado em /app/openclaw.mjs"; \
    else \
      echo "ERRO: OpenClaw não encontrado na imagem base!" && exit 1; \
    fi

# Criar usuário não-root (se não existir)
RUN addgroup -g 1000 node 2>/dev/null || true && \
    adduser -u 1000 -G node -s /bin/sh -D node 2>/dev/null || true

# Criar diretório de configuração
RUN mkdir -p /home/node/.openclaw && \
    chown -R node:node /home/node/.openclaw

# Mudar para usuário não-root
USER node
ENV HOME=/home/node
ENV PATH="/home/node/.local/bin:${PATH}"

# Expor porta padrão do OpenClaw
EXPOSE 18789

# Script de inicialização otimizado
COPY --chown=node:node entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
